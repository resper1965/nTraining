#!/bin/bash

# DiagnÃ³stico completo de OAuth via Google Cloud API
# Foca no erro "acesso bloqueado" - flowName=GeneralOAuthFlow

PROJECT_ID="ntraining-484414"
PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format="value(projectNumber)" 2>&1)

echo "ğŸ” DIAGNÃ“STICO OAuth - Erro: 'acesso bloqueado'"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“‹ Projeto: $PROJECT_ID"
echo "ğŸ“‹ Project Number: $PROJECT_NUMBER"
echo ""

# Obter access token
ACCESS_TOKEN=$(gcloud auth print-access-token 2>&1)
if [[ "$ACCESS_TOKEN" == *"ERROR"* ]] || [ -z "$ACCESS_TOKEN" ]; then
    echo "âŒ Erro ao obter access token"
    echo "   Execute: gcloud auth login"
    exit 1
fi

echo "âœ… Access token obtido"
echo ""

# Tentar obter informaÃ§Ãµes do OAuth Consent Screen
echo "ğŸ“‹ 1. Verificando OAuth Consent Screen..."
echo "   (Pode nÃ£o retornar dados se nÃ£o tiver permissÃµes completas)"
echo ""

CONSENT_INFO=$(curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
    "https://iap.googleapis.com/v1/projects/$PROJECT_NUMBER/iap_web:GetIapSettings" 2>&1)

if [[ "$CONSENT_INFO" == *"error"* ]] || [[ "$CONSENT_INFO" == *"403"* ]] || [[ "$CONSENT_INFO" == *"Permission"* ]]; then
    echo "âš ï¸  NÃ£o foi possÃ­vel acessar via API (requer permissÃµes IAP)"
    echo "   Usando mÃ©todo alternativo..."
else
    echo "$CONSENT_INFO" | head -30
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” ANÃLISE DO ERRO: 'acesso bloqueado' - flowName=GeneralOAuthFlow"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Este erro indica que o Google estÃ¡ BLOQUEANDO o fluxo OAuth."
echo ""
echo "ğŸ”´ CAUSAS MAIS COMUNS (em ordem de probabilidade):"
echo ""
echo "1. âš ï¸  OAuth Consent Screen em modo 'Testing'"
echo "   - A tela de consentimento estÃ¡ configurada para 'Testing'"
echo "   - Apenas usuÃ¡rios na lista de 'Test users' podem fazer login"
echo "   - SOLUÃ‡ÃƒO: Adicionar seu email aos test users OU publicar o app"
echo ""
echo "2. âš ï¸  DomÃ­nios nÃ£o autorizados"
echo "   - Algum domÃ­nio usado nÃ£o estÃ¡ na lista de 'Authorized domains'"
echo "   - SOLUÃ‡ÃƒO: Adicionar todos os domÃ­nios usados na tela de consentimento"
echo ""
echo "3. âš ï¸  URLs de redirect incorretas"
echo "   - As URLs de redirect no OAuth client nÃ£o correspondem"
echo "   - SOLUÃ‡ÃƒO: Verificar e corrigir URLs no OAuth Client"
echo ""
echo "4. âš ï¸  Client ID/Secret incorretos no Supabase"
echo "   - Credenciais no Supabase nÃ£o correspondem ao Google Cloud"
echo "   - SOLUÃ‡ÃƒO: Verificar e atualizar credenciais no Supabase"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… SOLUÃ‡ÃƒO RÃPIDA (passo a passo):"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "PASSO 1: Verificar OAuth Consent Screen"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Acesse: https://console.cloud.google.com/apis/credentials/consent?project=$PROJECT_ID"
echo ""
echo "Verifique:"
echo "  â–¡ Status Ã© 'In production' OU"
echo "  â–¡ Se for 'Testing', seu email (resper@ness.com.br) estÃ¡ em 'Test users'"
echo ""
echo "Se estiver em 'Testing' e vocÃª NÃƒO estiver na lista:"
echo "  1. Role atÃ© 'Test users'"
echo "  2. Clique em '+ ADD USERS'"
echo "  3. Adicione: resper@ness.com.br"
echo "  4. Clique em 'SAVE'"
echo ""
echo "OU publique o app:"
echo "  1. Role atÃ© o final da pÃ¡gina"
echo "  2. Clique em 'PUBLISH APP'"
echo "  3. Confirme"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "PASSO 2: Verificar DomÃ­nios Autorizados"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Na mesma pÃ¡gina (OAuth Consent Screen), role atÃ© 'Authorized domains'"
echo ""
echo "Certifique-se de que contÃ©m:"
echo "  â–¡ srrbomtdkghjxdhpeyel.supabase.co"
echo "  â–¡ n-training.vercel.app"
echo "  â–¡ ntraining.ness.com.br"
echo "  â–¡ ness.com.br"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "PASSO 3: Verificar OAuth Client URLs"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Acesse: https://console.cloud.google.com/apis/credentials?project=$PROJECT_ID"
echo ""
echo "Clique no OAuth Client ('n.training Web Client')"
echo ""
echo "Verifique 'Origens JavaScript autorizadas':"
echo "  â–¡ https://srrbomtdkghjxdhpeyel.supabase.co"
echo "  â–¡ https://n-training.vercel.app"
echo "  â–¡ https://ntraining.ness.com.br"
echo ""
echo "Verifique 'URIs de redirecionamento autorizadas':"
echo "  â–¡ https://srrbomtdkghjxdhpeyel.supabase.co/auth/v1/callback"
echo "  â–¡ https://n-training.vercel.app/auth/callback"
echo "  â–¡ https://ntraining.ness.com.br/auth/callback"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "PASSO 4: Verificar Supabase"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Acesse: https://supabase.com/dashboard/project/srrbomtdkghjxdhpeyel/auth/providers"
echo ""
echo "Verifique:"
echo "  â–¡ Google provider estÃ¡ habilitado (ON)"
echo "  â–¡ Client ID corresponde ao Google Cloud Console"
echo "  â–¡ Client Secret corresponde ao Google Cloud Console"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "PASSO 5: Testar"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Limpe cookies do navegador (ou use modo anÃ´nimo)"
echo "2. Aguarde 2-3 minutos apÃ³s fazer alteraÃ§Ãµes"
echo "3. Acesse: https://n-training.vercel.app/auth/login"
echo "4. Clique em 'Continuar com Google'"
echo "5. FaÃ§a login com: resper@ness.com.br"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ’¡ DICA: A causa mais comum (90% dos casos) Ã© a OAuth Consent Screen"
echo "   estar em modo 'Testing' sem o usuÃ¡rio na lista de test users."
echo ""
echo "   Foque primeiro nisso antes de verificar outras configuraÃ§Ãµes."
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
